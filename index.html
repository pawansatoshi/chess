<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monad Chess DApp</title>
  <!-- Libraries -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>
  <style>
    body { font-family: Arial,sans-serif; margin:0; padding:0; background:#111; color:#eee; text-align:center; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#1a1a1a; }
    header img { height:50px; }
    h1 { margin:10px 0; }
    #board { width:400px; margin:20px auto; }
    button { padding:10px 20px; margin:10px; border:none; background:#4caf50; color:white; border-radius:8px; cursor:pointer; font-size:16px; }
    button:hover { background:#45a049; }
    #status { margin-top:15px; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <img src="fox_logo.png" alt="Fox Logo">
    <h2>Monad Chess DApp</h2>
    <img src="monad_logo.png" alt="Monad Logo">
  </header>

  <h1>â™Ÿ Play Chess on Monad</h1>
  <div id="board"></div>

  <button id="connectBtn">Connect Wallet</button>
  <p id="status">Not Connected</p>

  <script>
    const CONTRACT_ADDRESS = "0x927E5DF0b0a5971cA625051C4116A2515525dCEb";
    const ABI = [
      { "inputs":[{"internalType":"string","name":"move","type":"string"}],"name":"makeMove","outputs":[],"stateMutability":"nonpayable","type":"function" }
    ];

    const MONAD_CHAIN = {
      chainId: "0x279F", // 10143
      chainName: "Monad Testnet",
      nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
      rpcUrls: ["https://testnet-rpc.monad.xyz"],
      blockExplorerUrls: ["https://testnet.monadexplorer.com"]
    };

    let signer, contract;
    const chess = new Chess();
    const board = Chessboard('board', { draggable: true, position: 'start', onDrop: handleMove });

    document.getElementById("connectBtn").onclick = async () => {
      try {
        let injected = window.ethereum || window.okxwallet || window.bitkeep || window.coinbaseWalletExtension;
        if (!injected) return alert("Open in MetaMask, OKX, Trust, etc.");

        await injected.request({ method: "eth_requestAccounts" });

        try {
          await injected.request({ method: "wallet_switchEthereumChain", params: [{ chainId: MONAD_CHAIN.chainId }] });
        } catch (err) {
          if (err.code === 4902) {
            await injected.request({ method: "wallet_addEthereumChain", params: [MONAD_CHAIN] });
          } else throw err;
        }

        const ep = new ethers.providers.Web3Provider(injected);
        signer = ep.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const addr = await signer.getAddress();
        document.getElementById("status").innerText = "Connected: " + addr;
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Connection Failed";
      }
    };

    async function handleMove(src, dst) {
      const mv = chess.move({ from: src, to: dst, promotion: 'q' });
      if (!mv) return 'snapback';
      board.position(chess.fen());

      if (contract) {
        try {
          document.getElementById("status").innerText = "Sending move...";
          await (await contract.makeMove(mv.san)).wait();
          document.getElementById("status").innerText = "Move confirmed on Monad";
        } catch (err) {
          console.error(err);
          document.getElementById("status").innerText = "Tx failed";
        }
      }
    }
  </script>
</body>
</html>
